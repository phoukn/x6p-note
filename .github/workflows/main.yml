name: æ£€æŸ¥çŽ©æœºç¬”è®° & é¼“åŠ±ä¸€ä¸‹ V2

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  check-and-cheer:
    runs-on: ubuntu-latest

    steps:
      - name: ä¸‹è½½ä»“åº“
        uses: actions/checkout@v4

      - name: è°ƒè¯•ï¼šåˆ—å‡ºæ ¹ç›®å½•æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼ˆå¸®æˆ‘ä»¬æŽ’æŸ¥è·¯å¾„ï¼‰
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•å†…å®¹ï¼š"
          ls -la
          echo "shell script backup æ–‡ä»¶å¤¹å†…å®¹ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰ï¼š"
          ls -la "shell script backup" || echo "æ–‡ä»¶å¤¹ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®ï½ž"

      - name: å®‰è£… shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck || echo "shellcheck å®‰è£…å¤±è´¥ï¼Œä½†ç»§ç»­"

      - name: æ£€æŸ¥ shell script backup é‡Œçš„ .sh æ–‡ä»¶
        run: |
          SHELL_DIR="shell script backup"
          if [ -d "$SHELL_DIR" ] && ls "$SHELL_DIR"/*.sh >/dev/null 2>&1; then
            echo "æ‰¾åˆ° .sh æ–‡ä»¶ï¼Œå¼€å§‹æ£€æŸ¥è¯­æ³•..."
            shellcheck "$SHELL_DIR"/*.sh || echo "shellcheck å‘çŽ°è­¦å‘Šï¼ˆå¸¸è§å°é—®é¢˜ï¼Œä¸å½±å“è¿è¡Œï¼‰ï¼Œç»§ç»­çŽ©æœºï¼"
          else
            echo "æ²¡æ‰¾åˆ° shell script backup æˆ–é‡Œé¢æ²¡ .sh æ–‡ä»¶ï¼Œè·³è¿‡æ£€æŸ¥ï½ž"
          fi

      - name: ç®€å•æ£€æŸ¥ host æ–‡ä»¶
        run: |
          if [ -f "host" ]; then
            echo "æ£€æŸ¥ host æ–‡ä»¶..."
            localhost_count=$(grep -c "127.0.0.1.*localhost" host 2>/dev/null || echo 0)
            if [ "$localhost_count" -gt 2 ]; then
              echo "è­¦å‘Šï¼šlocalhost å‡ºçŽ°äº† $localhost_count æ¬¡ï¼Œå¯èƒ½æœ‰é‡å¤æ¡ç›®ï¼"
            else
              echo "host æ–‡ä»¶æ­£å¸¸ï¼ˆlocalhost å‡ºçŽ° $localhost_count æ¬¡ï¼‰"
            fi
            empty_lines=\( (grep -c "^ \)" host 2>/dev/null || echo 0)
            echo "æœ‰ $empty_lines ä¸ªç©ºè¡Œï¼ˆæ­£å¸¸ï¼‰"
            echo "host æ–‡ä»¶æ€»è¡Œæ•°ï¼š$(wc -l < host)"
          else
            echo "æ²¡æ‰¾åˆ° host æ–‡ä»¶ï¼Œè·³è¿‡ï½ž"
          fi

      - name: çŽ©æœºé¼“åŠ±ï¼
        run: |
          echo "Root ç¨³äº†ï¼ç»§ç»­çŽ©æœºï½ž ðŸ˜Ž"
          echo "LA æ—¶é—´çŽ°åœ¨æ˜¯ $(TZ=America/Los_Angeles date '+%Y-%m-%d %H:%M')"
          echo "ç¬”è®°æ£€æŸ¥å®Œæ¯•ï¼Œæ”¾å¿ƒ pushï¼ðŸ”"            else
              echo "host æ–‡ä»¶çœ‹èµ·æ¥æ­£å¸¸ï¼ˆlocalhost å‡ºçŽ° $localhost_count æ¬¡ï¼‰"
            fi
            # æ£€æŸ¥ç©ºè¡Œæˆ–æ˜Žæ˜¾æ— æ•ˆè¡Œï¼ˆå¯é€‰åŠ ä¸¥ï¼‰
            empty_lines=\( (grep -c "^ \)" host || true)
            echo "æœ‰ $empty_lines ä¸ªç©ºè¡Œï¼ˆæ­£å¸¸ï¼‰"
          else
            echo "æ²¡æ‰¾åˆ° host æ–‡ä»¶ï¼Œè·³è¿‡ï½ž"
          fi

      - name: çŽ©æœºé¼“åŠ±ï¼
        run: |
          echo "Root ç¨³äº†ï¼ç»§ç»­çŽ©æœºï½ž ðŸ˜Ž"
          echo "LA æ—¶é—´çŽ°åœ¨æ˜¯ $(TZ=America/Los_Angeles date '+%Y-%m-%d %H:%M')"
          echo "ä»Šå¤©çš„ hosts å’Œ shell éƒ½æ£€æŸ¥è¿‡äº†ï¼Œæ”¾å¿ƒ pushï¼ðŸ”"
