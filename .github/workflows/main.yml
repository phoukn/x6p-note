name: Lint, Validate & Compile Rules

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# å¿…é¡»æ·»åŠ å†™æƒé™ï¼Œå…è®¸ Github Action æœºå™¨äººæŠŠç”Ÿæˆçš„ srs/mrs æ–‡ä»¶æ¨é€åˆ°ä½ çš„ä»“åº“
permissions:
  contents: write

jobs:
  lint-and-compile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} > changed.txt
          else
            git diff --name-only HEAD^ HEAD > changed.txt || touch changed.txt
          fi
          echo "Changed files:"
          cat changed.txt

      - name: Install tools
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck jq python3-pip gzip tar
          
          pip install flake8 yamllint --break-system-packages
          npm install -g markdownlint-cli
          
          echo "=== ä¸‹è½½ Mihomo ==="
          MIHOMO_URL=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r '.assets[] | select(.name | contains("linux-amd64-compatible") and contains(".gz")) | .browser_download_url' | head -n 1)
          curl -L -o mihomo.gz "$MIHOMO_URL"
          gzip -d mihomo.gz
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/

          echo "=== ä¸‹è½½ Sing-box ==="
          SING_URL=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r '.assets[] | select(.name | contains("linux-amd64.tar.gz")) | .browser_download_url' | head -n 1)
          curl -L -o sing-box.tar.gz "$SING_URL"
          tar -xzf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/

      - name: Lint changed Markdown files
        run: |
          IFS=$'\n'
          for f in $(grep -E '\.md$' changed.txt || true); do
            [ -z "$f" ] && continue
            markdownlint "$f" || echo "::warning file=$f::MD æ ¼å¼æœ‰è­¦å‘Š"
          done

      - name: Lint changed YAML (mihomo configs)
        run: |
          IFS=$'\n'
          for f in $(grep -E 'surfing/.*\.ya?ml$' changed.txt || true); do
            [ -z "$f" ] && continue
            yamllint -d "{extends: relaxed, rules: {line-length: disable}}" "$f" || echo "::warning file=$f::yamllint è­¦å‘Š"
            mihomo -t -f "$f" || { echo "::error file=$f::mihomo æµ‹è¯•å¤±è´¥"; exit 1; }
          done

      - name: Compile & Validate Sing-box (.json -> .srs)
        run: |
          IFS=$'\n'
          for f in $(grep -E 'sing-box/.*\.json$' changed.txt || true); do
            [ -z "$f" ] && continue
            if grep -q '"version"' "$f" && grep -q '"rules"' "$f"; then
              echo "æ£€æµ‹ä¸º Sing-box è§„åˆ™é›†ï¼Œæ­£åœ¨ç¼–è¯‘ä¸º .srs..."
              # ç›´æ¥å°†åŒåæ–‡ä»¶ç¼–è¯‘ä¸º .srs
              srs_file="${f%.json}.srs"
              sing-box rule-set compile "$f" -o "$srs_file" || { echo "::error file=$f::Sing-box è§„åˆ™é›†ç¼–è¯‘å¤±è´¥"; exit 1; }
              echo "âœ… æˆåŠŸç”Ÿæˆ $srs_file"
            else
              echo "æ£€æµ‹ä¸º Sing-box é…ç½®æ–‡ä»¶ï¼Œè¿›è¡Œåˆæ³•æ€§æµ‹è¯•..."
              sing-box check -c "$f" || { echo "::error file=$f::Sing-box é…ç½®æ–‡ä»¶é”™è¯¯"; exit 1; }
            fi
          done

      - name: Compile & Validate Mihomo (.list -> .mrs)
        run: |
          IFS=$'\n'
          for f in $(grep -E 'surfing/.*\.list$' changed.txt || true); do
            [ -z "$f" ] && continue
            echo "æ ¡éªŒ Mihomo/Clash è§„åˆ™é›†: $f"
            awk -F, '
              /^\s*(#|$)/ {next}
              {
                if (NF < 2) { print "::error file=" FILENAME ",line=" NR "::ç¼ºå°‘é€—å·: " $0; exit 1; }
                gsub(/^[ \t]+|[ \t]+$/, "", $1);
                if ($1 !~ /^(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD|DOMAIN-REGEX|IP-CIDR|IP-CIDR6|GEOIP|SRC-IP-CIDR|SRC-PORT|DST-PORT|PROCESS-NAME|PROCESS-PATH|IP-ASN|RULE-SET)$/) {
                  print "::error file=" FILENAME ",line=" NR "::æœªçŸ¥è§„åˆ™ç±»å‹: [" $1 "] åœ¨è¡Œ: " $0; exit 1;
                }
              }
            ' "$f" || exit 1
            
            echo "æ ¡éªŒé€šè¿‡ï¼Œæ­£åœ¨ç¼–è¯‘ä¸º .mrs..."
            # ä½¿ç”¨ mihomo å°† classic text(.list) ç¼–è¯‘ä¸º .mrs
            mrs_file="${f%.list}.mrs"
            mihomo convert-ruleset classic text "$f" "$mrs_file" || { echo "::error file=$f::Mihomo MRSç¼–è¯‘å¤±è´¥"; exit 1; }
            echo "âœ… æˆåŠŸç”Ÿæˆ $mrs_file"
          done

      - name: Lint changed Shell / Python / JS / Hosts
        run: |
          IFS=$'\n'
          for f in $(grep -E '\.sh$' changed.txt || true); do [ -n "$f" ] && shellcheck "$f" || true; done
          for f in $(grep -E '\.py$' changed.txt || true); do [ -n "$f" ] && flake8 --ignore=E501 "$f" || true; done
          for f in $(grep -E '\.js$' changed.txt || true); do [ -n "$f" ] && node --check "$f" || exit 1; done
          if grep -q '^hosts/host$' changed.txt; then
            awk '!/^\s*(#|$)/ {if (NF < 2 || $1 !~ /^(#|([0-9a-fA-F:.]+))$/) {print "::error line="NR"::hosts æ ¼å¼å¼‚å¸¸"; exit 1}}' "hosts/host" || exit 1
          fi

      - name: Commit and Push compiled rules (.srs / .mrs)
        run: |
          # é…ç½® Github Action æœºå™¨äººä½œä¸ºæäº¤è€…
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # å°†åˆšæ‰ç”Ÿæˆæˆ–æ›´æ–°çš„ srs/mrs æ–‡ä»¶åŠ å…¥æš‚å­˜åŒºï¼ˆå³ä¾¿æ‰¾ä¸åˆ°å¯¹åº”æ–‡ä»¶ä¹Ÿä¼šé™é»˜è·³è¿‡ï¼‰
          git add sing-box/*.srs surfing/*.mrs 2>/dev/null || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ”¹åŠ¨ï¼Œå¦‚æœæœ‰åˆ™è‡ªåŠ¨æäº¤å¹¶æ¨é€åˆ°ä»“åº“
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– auto-compile: update .srs and .mrs rules"
            git push
            echo "ğŸ‰ è‡ªåŠ¨ç¼–è¯‘çš„è§„åˆ™å·²æ¨é€åˆ°ä»“åº“ï¼"
          else
            echo "ğŸ’¤ è§„åˆ™æ— å˜åŒ–ï¼Œè·³è¿‡è‡ªåŠ¨æäº¤ã€‚"
          fi

      - name: Final message
        run: |
          echo "æ£€æŸ¥ä¸ç¼–è¯‘å…¨æµç¨‹å®Œæ¯•ï¼Œç•…å¿«å†²æµªå§ï¼ğŸ˜"
          echo "ä¸œäº¬æ—¶é—´: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M')"
