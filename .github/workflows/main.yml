name: Lint & Validate Files

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ï¼Œç¡®ä¿èƒ½å¤Ÿå‡†ç¡®æ‰¾åˆ°å¢é‡æ–‡ä»¶

      - name: Get changed files
        id: changed-files
        run: |
          # å…¼å®¹ Push å’Œ PR äº‹ä»¶çš„å·®å¼‚æ–‡ä»¶è·å–
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} > changed.txt
          else
            git diff --name-only HEAD^ HEAD > changed.txt || touch changed.txt
          fi
          echo "Changed files:"
          cat changed.txt

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck jq python3-pip gzip tar
          
          # Ubuntu 24.04 pip å¿…é¡»åŠ  break-system-packages
          pip install flake8 yamllint --break-system-packages
          npm install -g markdownlint-cli
          
          echo "=== ä¸‹è½½ Mihomo ==="
          MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-linux-amd64-compatible.gz"
          curl -L -o mihomo.gz "$MIHOMO_URL"
          gzip -d mihomo.gz
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/

          echo "=== ä¸‹è½½ Sing-box ==="
          SING_URL=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r '.assets[] | select(.name | contains("linux-amd64.tar.gz")) | .browser_download_url' | head -n 1)
          curl -L -o sing-box.tar.gz "$SING_URL"
          tar -xzf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/

      - name: Lint changed Markdown files
        run: |
          IFS=$'\n' # è§£å†³æ–‡ä»¶åå¸¦ç©ºæ ¼çš„é—®é¢˜ï¼ˆå¦‚ shell script backup æ–‡ä»¶å¤¹ï¼‰
          for f in $(grep -E '\.md$' changed.txt || true); do
            [ -z "$f" ] && continue
            # markdownlint ä»…ä½œè­¦å‘Šå¤„ç†ï¼Œä¸ä¸­æ–­æµç¨‹
            markdownlint "$f" || echo "::warning file=$f::MD æ ¼å¼æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œï½"
          done

      - name: Lint changed YAML (mihomo configs)
        run: |
          IFS=$'\n'
          for f in $(grep -E 'surfing/.*\.ya?ml$' changed.txt || true); do
            [ -z "$f" ] && continue
            echo "æ£€æŸ¥ YAML: $f"
            yamllint -d "{extends: relaxed, rules: {line-length: disable}}" "$f" || echo "::warning file=$f::yamllint æ ¼å¼è­¦å‘Š"
            mihomo -t -f "$f" || { echo "::error file=$f::mihomo æµ‹è¯•å¤±è´¥ï¼ˆé…ç½®æœ‰é—®é¢˜ï¼‰"; exit 1; }
            echo "$f é€šè¿‡ mihomo æµ‹è¯• âœ…"
          done

      - name: Validate changed JSON (sing-box configs/rules)
        run: |
          IFS=$'\n'
          for f in $(grep -E 'sing-box/.*\.json$' changed.txt || true); do
            [ -z "$f" ] && continue
            echo "æ£€æŸ¥ Sing-box JSON: $f"
            
            # æ™ºèƒ½åˆ¤æ–­ï¼šå¦‚æœæ˜¯è§„åˆ™é›† (åŒ…å« "version" å’Œ "rules")
            if grep -q '"version"' "$f" && grep -q '"rules"' "$f"; then
              echo "æ£€æµ‹ä¸º Sing-box Rule-set è§„åˆ™é›†ï¼Œè¿›è¡Œä¸¥æ ¼ç¼–è¯‘æµ‹è¯•..."
              sing-box rule-set compile "$f" -o test.srs || { echo "::error file=$f::Sing-box è§„åˆ™é›†ç¼–è¯‘å¤±è´¥ï¼ˆå­˜åœ¨éæ³•å­—æ®µæˆ–è¯­æ³•é”™è¯¯ï¼‰"; exit 1; }
              rm -f test.srs
              echo "$f è§„åˆ™é›†ç¼–è¯‘é€šè¿‡ âœ…"
            else
              echo "æ£€æµ‹ä¸º Sing-box é…ç½®æ–‡ä»¶ï¼Œè¿›è¡Œç»“æ„æµ‹è¯•..."
              sing-box check -c "$f" || { echo "::error file=$f::Sing-box é…ç½®æ–‡ä»¶é”™è¯¯"; exit 1; }
              echo "$f é…ç½®æ–‡ä»¶åˆæ³• âœ…"
            fi
          done

      - name: Check changed .list files (clash rules)
        run: |
          IFS=$'\n'
          for f in $(grep -E '\.list$' changed.txt || true); do
            [ -z "$f" ] && continue
            echo "æ£€æŸ¥ Mihomo/Clash .list è§„åˆ™é›†: $f"
            # ä½¿ç”¨ awk ä¸¥æ ¼æ ¡éªŒè§„åˆ™æ ¼å¼åŠè§„åˆ™ç±»å‹
            awk -F, '
              /^\s*(#|$)/ {next} # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
              {
                if (NF < 2) {
                  print "::error file=" FILENAME ",line=" NR "::è¯­æ³•ç¼ºå°‘é€—å·: " $0; 
                  exit 1;
                }
                gsub(/^[ \t]+|[ \t]+$/, "", $1); # æ¸…é™¤ç±»å‹å‰åçš„ç©ºæ ¼
                # ç™½åå•æ ¡éªŒ
                if ($1 !~ /^(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD|DOMAIN-REGEX|IP-CIDR|IP-CIDR6|GEOIP|SRC-IP-CIDR|SRC-PORT|DST-PORT|PROCESS-NAME|PROCESS-PATH|IP-ASN|RULE-SET)$/) {
                  print "::error file=" FILENAME ",line=" NR "::æœªçŸ¥çš„è§„åˆ™ç±»å‹: [" $1 "] åœ¨è¡Œ: " $0; 
                  exit 1;
                }
              }
            ' "$f" || { echo "::error file=$f::.list è§„åˆ™é›†æ ¡éªŒæœªé€šè¿‡"; exit 1; }
            echo "$f è§„åˆ™ç±»å‹æ ¡éªŒé€šè¿‡ âœ…"
          done

      - name: Check changed hosts file
        run: |
          if grep -q '^hosts/host$' changed.txt; then
            f="hosts/host"
            echo "æ£€æŸ¥ hosts: $f"
            awk '!/^\s*(#|$)/ {if (NF < 2 || $1 !~ /^(#|([0-9a-fA-F:.]+))$/ ) {print "::error file=" FILENAME ",line=" NR "::æ ¼å¼å¼‚å¸¸è¡Œ: " $0; exit 1}}' "$f" || { echo "::error file=$f::hosts æ ¼å¼é”™è¯¯"; exit 1; }
            echo "hosts æ ¼å¼æ ¡éªŒé€šè¿‡ âœ…"
          fi

      - name: Lint changed Shell scripts
        run: |
          IFS=$'\n'
          for f in $(grep -E '\.sh$' changed.txt || true); do
            [ -z "$f" ] && continue
            shellcheck "$f" || echo "::warning file=$f::Shell è„šæœ¬æœ‰ä¼˜åŒ–å»ºè®®"
          done

      - name: Lint changed Python scripts
        run: |
          IFS=$'\n'
          for f in $(grep -E '\.py$' changed.txt || true); do
            [ -z "$f" ] && continue
            flake8 --ignore=E501 "$f" || echo "::warning file=$f::Python ä»£ç é£æ ¼æœ‰è­¦å‘Š"
          done

      - name: Lint changed JS (tampermonkey)
        run: |
          IFS=$'\n'
          for f in $(grep -E '\.js$' changed.txt || true); do
            [ -z "$f" ] && continue
            node --check "$f" || { echo "::error file=$f::JS å­˜åœ¨è‡´å‘½è¯­æ³•é”™è¯¯"; exit 1; }
            echo "$f JS è¯­æ³•æ ¡éªŒé€šè¿‡ âœ…"
          done

      - name: Final message
        run: |
          echo "ğŸ‰ æ£€æŸ¥å®Œæˆï¼æ‰€æœ‰éªŒè¯å‡å·²é€šè¿‡ï¼Œç»§ç»­ç©æœºï½ ğŸ˜"
          echo "ğŸš€ ä¸œäº¬æ—¶é—´: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M')"
