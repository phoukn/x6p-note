name: Lint, Validate & Compile Rules

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 6 ç‚¹ (UTC 22:00) è‡ªåŠ¨è¿è¡Œï¼Œå¼ºåˆ¶å…¨é‡ç¼–è¯‘å¹¶æ›´æ–°ä¸Šæ¸¸è§„åˆ™
  schedule:
    - cron: '0 22 * * *'

permissions:
  contents: write

jobs:
  lint-and-compile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files (For Linting)
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} > changed.txt
          else
            git diff --name-only HEAD^ HEAD > changed.txt || touch changed.txt
          fi

      - name: Install tools
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck jq python3-pip gzip tar
          pip install flake8 yamllint --break-system-packages
          npm install -g markdownlint-cli
          
          # ä¸‹è½½ Mihomo
          MIHOMO_URL=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r '.assets[] | select(.name | contains("linux-amd64-compatible") and contains(".gz")) | .browser_download_url' | head -n 1)
          curl -L -o mihomo.gz "$MIHOMO_URL"
          gzip -d mihomo.gz
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/

          # ä¸‹è½½ Sing-box
          SING_URL=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r '.assets[] | select(.name | contains("linux-amd64.tar.gz")) | .browser_download_url' | head -n 1)
          curl -L -o sing-box.tar.gz "$SING_URL"
          tar -xzf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/

      - name: Fetch upstream rules (AWAvenue-Ads)
        run: |
          echo "ğŸ”„ æ­£åœ¨ä»ä¸Šæ¸¸æŠ“å– AWAvenue å»å¹¿å‘Šè§„åˆ™..."
          curl -L -o sing-box/AWAvenue-Ads-Rule-Singbox.json "https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Singbox.json"
          echo "âœ… ä¸Šæ¸¸è§„åˆ™ä¸‹è½½å®Œæˆï¼"

      - name: Compile ALL Sing-box Rule-sets (.json -> .srs)
        run: |
          echo "ğŸ”„ å¼€å§‹å…¨å±€æ‰«æå¹¶å…¨é‡ç¼–è¯‘ Sing-box è§„åˆ™é›†..."
          for f in sing-box/*.json; do
            [ -e "$f" ] || continue 
            
            if grep -q '"version"' "$f" && grep -q '"rules"' "$f"; then
              srs_file="${f%.json}.srs"
              rm -f "$srs_file" # ã€ç»æ€ã€‘å…ˆå¼ºåˆ¶åˆ é™¤æ—§çš„äºŒè¿›åˆ¶æ–‡ä»¶
              if sing-box rule-set compile "$f" -o "$srs_file"; then
                echo "âœ… å·²ç”Ÿæˆ: $srs_file"
              else
                echo "::error file=$f::Sing-box è§„åˆ™é›†ç¼–è¯‘å¤±è´¥ï¼Œå·²è·³è¿‡ï¼"
              fi
            else
              if sing-box check -c "$f"; then
                echo "âœ… é…ç½®æ–‡ä»¶åˆæ³•: $f"
              else
                echo "::error file=$f::Sing-box é…ç½®æ–‡ä»¶æ ¼å¼æœ‰è¯¯ï¼Œå·²è·³è¿‡ï¼"
              fi
            fi
          done

      - name: Compile ALL Mihomo Rules (.list -> .mrs)
        run: |
          echo "ğŸ”„ å¼€å§‹å…¨å±€æ‰«æå¹¶å…¨é‡ç¼–è¯‘ Mihomo è§„åˆ™é›†..."
          for f in surfing/*.list; do
            [ -e "$f" ] || continue
            
            mrs_file="${f%.list}.mrs"
            rm -f "$mrs_file" # ã€ç»æ€ã€‘å…ˆå¼ºåˆ¶åˆ é™¤æ—§çš„äºŒè¿›åˆ¶æ–‡ä»¶
            if mihomo convert-ruleset classical text "$f" "$mrs_file"; then
              echo "âœ… å·²ç”Ÿæˆ: $mrs_file"
            else
              echo "::error file=$f::Mihomo MRSç¼–è¯‘å¤±è´¥ï¼Œå·²è·³è¿‡ï¼"
            fi
          done

      - name: Lint changed Scripts & Hosts
        run: |
          IFS=$'\n'
          for f in $(grep -E '\.sh$' changed.txt || true); do [ -n "$f" ] && shellcheck "$f" || true; done
          for f in $(grep -E '\.py$' changed.txt || true); do [ -n "$f" ] && flake8 --ignore=E501 "$f" || true; done
          for f in $(grep -E '\.js$' changed.txt || true); do 
            if [ -n "$f" ]; then
              node --check "$f" || echo "::error file=$f::JS å­˜åœ¨è¯­æ³•é”™è¯¯ï¼Œå·²è·³è¿‡ï¼"
            fi
          done
          if grep -q '^hosts/host$' changed.txt; then
            awk '!/^\s*(#|$)/ {if (NF < 2 || $1 !~ /^(#|([0-9a-fA-F:.]+))$/) {print "::error line="NR"::hosts æ ¼å¼å¼‚å¸¸"; exit 1}}' "hosts/host" || echo "hostsæ ¡éªŒæŠ›å‡ºè­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          fi

      - name: Commit and Push compiled rules
        if: always()
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add sing-box/AWAvenue-Ads-Rule-Singbox.json || true
          find sing-box -name "*.srs" -exec git add {} + || true
          find surfing -name "*.mrs" -exec git add {} + || true
          
          echo "============== Git çŠ¶æ€é€è§† =============="
          git status
          echo "========================================="
          
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– auto-update: åŒæ­¥è§„åˆ™å¹¶å…¨é‡ç¼–è¯‘ .srs / .mrs"
            git push
            echo "ğŸ‰ è‡ªåŠ¨ç¼–è¯‘çš„è§„åˆ™å·²æ¨é€åˆ°ä»“åº“ï¼"
          else
            echo "ğŸ’¤ æºç æ— å®è´¨æ€§ä¿®æ”¹ï¼Œç”Ÿæˆçš„äºŒè¿›åˆ¶æ•°æ®ä¸ä¸Šæ¬¡å®Œå…¨ä¸€è‡´ï¼Œè·³è¿‡æäº¤ã€‚"
          fi

      - name: Final message
        if: always()
        run: |
          echo "æ£€æŸ¥ä¸ç¼–è¯‘å…¨æµç¨‹å®Œæ¯•ï¼Œç•…å¿«å†²æµªå§ï¼ğŸ˜"
          echo "ä¸œäº¬æ—¶é—´: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M')"
